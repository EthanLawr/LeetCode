name: "CodeQL"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * 0'

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'javascript,python,cpp,csharp,java'

      # Optional: explicit build steps to help CodeQL detect and analyze Java / C# projects
      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build Java projects (if present)
        shell: bash
        run: |
          set -e
          if [ -f pom.xml ]; then
            echo "Detected Maven project (pom.xml) — packaging (skip tests)"
            mvn -B -DskipTests package || true
          elif [ -f build.gradle ] || [ -f build.gradle.kts ]; then
            echo "Detected Gradle project — building (skip tests)"
            chmod +x ./gradlew || true
            ./gradlew build -x test || true
          else
            echo "No Java build files detected; skipping Java build."
          fi

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.0.x'

      - name: Build .NET projects (if present)
        shell: bash
        run: |
          set -e
          # find any .csproj files and run dotnet restore/build per project
          csproj_count=$(find . -name "*.csproj" | wc -l)
          if [ "$csproj_count" -gt 0 ]; then
            echo "Found $csproj_count C# project(s) — restoring and building"
            find . -name "*.csproj" -print0 | while IFS= read -r -d '' proj; do
              echo "Building $proj"
              dotnet restore "$proj" || true
              dotnet build "$proj" -c Release --no-restore || true
            done
          else
            echo "No C# project files detected; skipping .NET build."
          fi

      - name: Build C++ projects (manual)
        shell: bash
        run: |
          set -euo pipefail
          # Attempt a simple compile of any .cpp files so CodeQL can analyze compiled artifacts.
          # If you have a proper build system (CMake, Makefile), prefer invoking it here.
          cpp_found=$(find . -name '*.cpp' -not -path './.git/*' -print -quit || true)
          if [ -z "$cpp_found" ]; then
            echo "No C++ source files detected; skipping C++ build."
          else
            echo "C++ source detected; compiling each .cpp into build-codeql/"
            mkdir -p build-codeql
            while IFS= read -r -d '' src; do
              # create a reproducible output name
              out="build-codeql/$(basename "$src" .cpp)"
              echo "Compiling $src -> $out"
              # compile with debug symbols to help CodeQL
              g++ -std=c++17 -g -O0 -I. "$src" -o "$out" || true
            done < <(find . -name '*.cpp' -not -path './.git/*' -print0)
          fi

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
